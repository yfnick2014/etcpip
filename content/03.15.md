#技巧15 理解TCP写操作
##从应用程序看写操作
当用户程序在TCP连接上调用一个写操作时，首先发生的事情是数据从用户的缓冲区拷贝到内核。从这一点来说，所发生的事情依赖于连接所处的状态。TCP可能决定发送所有数据、或者部分数据，或者什么数据也不发送。

程序员很容易认为当写n个字节返回值n时，这n个字节实际上已经发送到对等方，甚至是被确认了。不幸的是，TCP尽可能多地发送它能发送的数据（有可能什么也不发送），然后立刻返回值n。应用程序不能断定究竟发送了多少数据，也不能断定对等方是否确认发送的数据。

通常，除非TCP发送缓冲区已满，否则写操作是不会阻塞的。这意味着写操作几乎总是立即返回，而且如果它们返回了，也不能保证所写数据的位置。

从应用程序方面来看，数据已经写入TCP了，因此TCP的“保证递交”保证了它会到达对等方。实际上，当写操作返回时，因为写入的部分或全部数据可能仍然在排队等待传输，所以如果对等方主机或应用程序这时崩溃的话，数据将会丢失。（如果发送方应用程序崩溃的话，TCP就会继续设法传送数据给对等方）

然而，对于TCP来说，通常会返回给写操作一个错误。因为写操作可能在数据实际传送之前返回，所以错误经常是通过下一个操作返回。因为下一个操作通常是读操作，所以可以这样说写操作错误通过读操作返回。写操作返回的错误仅仅是那些在调用写操作时就已经发生的错误，这些错误包括：

- 套接字描述符非法。
- 没有指向套接字的文件描述符（在调用send及其相应函数的情况下）。
- 调用里指定的套接字不存在或套接字没有连接。
- 缓冲区地址参数指定了一个非法的地址。

这些错误大多数是由不正确的代码引起的，在程序的开发阶段之后就很少遭到这些问题了。唯一的例外是EPIPE错误（或SIGPIPE信号），该错误在对等方重置连接时发生。

##从TCP看写操作
TCP发送机制的一个基本目标是尽可能高效地利用可获得的带宽。为了达到这个目的，TCP选择以MMS大小发送数据块。同时，发送的数据也不能超过对等方的缓冲区。它由TCP的发送窗口来控制。

如果仅仅需要考虑以上问题，那么发送机制就很简单：以MMS大小立即发送TCP发送窗口允许发送的最大的可获得的段。不幸的是，还有其他问题需要考虑。

首先需要考虑的是特别重要的拥塞控制问题。如果TCP将要突然地输入大量的段到网络中，路由器缓冲区空间可能会耗尽，导致路由器丢弃数据报。而这又会导致重传，进一步使网络拥挤。为了预防拥塞，TCP不能再一个空闲连接上突然发送几个段。TCP应当一开始时发送一个段，然后增加网络中没有确认的段的数量，直到达到一个稳定的状态。

TCP使用两个算法来预防拥塞。两种方法都使用额外的窗口，称作拥塞窗口，来控制拥塞。任何时候TCP发送数据的最大数量是发送窗口和拥塞窗口的最小值。注意这两个窗口负责流量控制的不同方面。发送窗口由本方TCP使用，以预防应用程序超过网络所能承受的能力。通过限制传输的数据为两个窗口的最小值，可以保证遵循两种类型的流量控制。

第一个流量控制算法，称作慢启动，“缓慢地”增加输入到网络中段的频率，直到达阀值。当拥塞窗口大小达到阀值，称作慢启动阀值（slow start threshold），慢启动过程就结束了，另一个拥塞预防算法接管过来。在拥塞预防阶段，连接假定为到达了稳定的状态，同时TCP还连续地探询网络有没有可获得的额外带宽。在拥塞预防阶段，拥塞窗口以线性的方式打开——每一个来回至多一个段。

对于TCP发送机制来说，拥塞窗口可以潜在地预防本来有可能发送出去的数据。如果发送了拥塞（通过丢失段可以知道），或者如果网络已经空闲了一段时间，拥塞窗口就会减小，也许减小到只有1个段。根据队列中排队数据的多少以及应用程序试图发送数据的多少，这种机制可以避免传输部分或全部的数据。

影响TCP发送机制的另一个因素是Nagle算法。该算法指出在任何给定的时间不能出现多于一个没有确认的“小段”，“小段”的意思是大小小于MSS的段。Nagle算法的目的就是避免TCP发送一系列的小段给网络造成数据泛滥。TCP在接受前一个小段的ACK消息之前，一直保存数据很小的数据。

任何时候调用TCP输出过程，它就会以发送缓冲区、发送窗口大小、拥塞窗口大小以及MSS的最小值来计算可以发送数据的数量。如果满足一下条件，数据就会发送：

1. 应用程序发送的是完全MSS大小的段。
2. 连接是空闲的，而且可以清空发送缓冲区。
3. Nagle算法被禁用了，而且可以清空发送缓冲区。
4. 有紧急的数据要发送。
5. 应用程序有小段要发送，该段已经“有一段时间”不能发送了。
6. 对等方的接收窗口至少一半是打开的。
7. TCP需要重传段。
8. TCP需要为对等方数据发送ACK消息。
9. TCP需要发布一个window update消息。
