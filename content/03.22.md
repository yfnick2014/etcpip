#技巧22 不要使用TIME-WAIT ASSASSINATION关闭连接
##什么是TIME-WAIT状态
（1）通常情况下，仅有一方——执行主动关闭操作的一方——进入TIME-WAIT状态。

（2）RFC 793定义MSL为2分钟。在这个定义下，连接在TIME-WAIT状态下保持4分钟。然而，该值在实际中被广泛地忽略掉了。例如，因为BSD派生的系统的MSL是30秒，所以TIME-WAIT状态持续一分钟。其他介于30秒和2分钟的值也很常见。

（3）如果连接处于TIME-WAIT状态期间有段到达，就重新启动一个2MSL计时器。

##为什么需要TIME-WAIT
（1）当由主动关闭方发送最后的ACK消息丢失并导致另一方重新发送FIN消息时，TIME-WAIT维护连接状态。

（2）TIME-WAIT为连接中“离群的段”提供从网络中消息的时间。

如果执行主动关闭的一方不进入TIME-WAIT状态就关闭连接那会发生什么呢？当重传的FIN消息达到时，因为TCP已经不再有连接的信息了，所以它就用RST消息应答，导致对等方进入错误状态而不是有序终止状态。但是如果发送最后ACK消息的一方处于TIME-WAIT状态并仍然记录着连接的信息，它就可以正确地响应来自对等方的FIN消息。

如果最后的ACK消息丢失了而对等方重传了FIN消息，处于TIME-WAIT状态的一方就会再次确认FIN消息。重新启动计时器是为了防止该ACK再次丢失。

TIME-WAIT状态的另一个目的更为重要。因为IP数据报在WAN中可能丢失或者延迟，所以TCP使用正面确认机制重传一定时间内没有被对等方确认的段。如果数据报仅仅是延时而不是丢失，或者是数据报的ACK消息丢失了，重传的数据就可能在原先的数据接收之后到达。TCP注意到延迟数据的序列是在当前接收窗口之外，处理并丢弃延迟的数据。

如果延迟或重传段在连接关闭之后到达时将会发生什么。通常情况下，因为TCP仅仅丢弃该数据并响应RST消息，所以这不会造成任何问题。当RST消息到达发出延时段的主机时，因为该主机也没有记录该连接的任何信息，所以它也丢弃该段。然而，如果两个相同主机之间又建立了一个具有相同端口号的新连接，那么离群的段就可能被看成是属于新连接的。如果离群的段中数据的任何序列号恰好处在新连接的当前接收窗口中，数据就会被新连接接收，其结果是破坏新连接。

TIME-WAIT状态通过确保旧套接字对在旧连接的段在网络上消失之前不会被重用来防止这种情况发生的。这样，我们可以看到TIME-WAIT状态在提供TCP的可靠性方面扮演者十分重要的角色。如果没有TIME-WAIT状态，TCP就不能保证“以顺序的方式不被破坏地”递交数据。