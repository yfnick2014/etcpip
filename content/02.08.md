#技巧8 不要彻底改造TCP
UDP在简单请求/应答的应用程序中的性能比TCP好很多。这就引导我们考虑使用UDP作为那些基于事务的应用程序的内部协议。然而，UDP协议是一个不可靠的协议，所以应用程序必须自己保障可靠性。

任何比较健壮的UDP应用程序都必须提供（1）在一定时间内没有接收到重传请求，（2）保证应答和请求的对应关系是正确的。

第一个要求可以通过在发送每个请求时设置一个计时器来达到，该计时器称作重传超时（RTO）计时器。如果计时器在应答到达之前超时了，该请求就必须重新发送。第二个要求可以通过附加一个序列号到每一个请求上并要求服务器在它的应答里返回该序列号来满足。

如果应用程序将要运行在Internet上，那么一个固定的RTO值将不是一个很好的选择，因为两个主机之间的RTT值即使在一个很短的时间间隔内也会有很大变化。因此，我们希望当网络条件变化时能够校正RTO计时器。而且，即使RTO计时器没有超时，也应当合理地为重传增加它的值，因为旧的值好像太小了。这使我们有必要进行重传时为RTO考虑一些指数级的缓冲空间。

其次，如果应用程序将要使用的不仅仅是简单的请求/应答协议，其中客户端发送一个请求然后在发送任何其他的数据报之前等待应答的到达，或者如果服务器的应答可以由多个数据报组成，那么我们需要提供某些类型的流量控制。

最后，如果应用程序涉及到连续传送多个数据报，我们就需要考虑流量控制了。不考虑流量控制就向网络中注入数据报的应用程序很容易给网络中的其他用户带来严重的吞吐量下降问题，并且有可能导致网络失败。

当我们审视应用程序使基于UDP协议变得可靠必须采用的所有步骤时，我们发现自己已经极大地改造了TCP。有时候这是不可避免的。毕竟，有些简单的基于事务的应用程序的TCP连接建立和撤销所需的时间可能达到甚至超过了发送和接收实际数据所需的时间。

而且，我们应当通过仔细地分析每一个应用程序来评估我们这么做是否合理。如果一个应用程序需要TCP的可靠性，那么TCP就是最好的解决方案。

首先，在一个用户应用程序中重复TCP的功能是不可能获得比较好的效率的。这部分是因为TCP的具体实现是大量的实验和研究的结果。经过了这么多年，TCP已经发展成了可以适应不同的环境和网络下的最细微的功能。

同时这也是因为TCP几乎总是在内核环境中运行。为了弄清楚这为什么会影响性能，让我们假定当应用程序的RTO计时器超时的时候到底会发生什么事情。首先，操作系统内核必须唤醒应用程序，这就需要切换到用户控件的上下文；接着应用程序必须重新发送数据，这需要切换回操作系统内核的另一个上下文，必须把数据报从用户空间拷贝到内核里；然后内核为数据报采用正确的路由，把它转移到适当的网络接口，并返回到应用程序，这又需要另一个切换上下文。这时应用程序必须安排再次设置RTO计时器，因此需要另一个切换到内核的上下文。

现在考虑一下当TCP的RTO计时器超时的时候会发生什么。因为内核已经有了数据的存储拷贝，所以没有必要重新从用户空间里拷贝过来，而且不需要切换上下文。TCP仅仅重新发送数据。这里的大部分工作主要涉及从内核缓冲区移动数据到网络接口上。因为TCP已经保存了这些信息，所以不必要计算路由。

避免在用户级别实现TCP的功能的另一个原因关系到当服务器的应答丢失时会发生什么事情。因为客户端没有接收到应答，所以它就会超时并重新发送请求。这意味着服务器再次处理该请求，而这是服务器所不希望的。